<!DOCTYPE HTML>
<html><head><title>Blog engine updates: Markdown Preprocessor &amp; Fay Scripts · in Code</title><meta name="description" content="Weblog of Justin Le, covering his various adventures in programming and explorations in the vast worlds of computation physics, and knowledge."><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><meta property="og:site_name" content="in Code"><meta property="og:description" content="I spent some time over the past week writing a preprocessor for the entry copy markdowns and getting Fay to deploy some simple scripts. The need for a preprocessor was sparked by a post I’m writing that sort of necessitated the features. I write all of my posts in markdown, and it all integrated well with the preprocessor. In addition I needed some javascript scripting to make the preprocessor actions worthwhile, so I buckled down and wrestled with getting Fay to work in a production environment. So I guess this post is to show off some new features of the blog engine?"><meta property="og:type" content="article"><meta property="og:title" content="Blog engine updates: Markdown Preprocessor &amp; Fay Scripts"><meta property="og:image" content="/img/site_logo.jpg"><meta property="og:locale" content="en_US"><meta property="og:url" content="http://home.jle0.com:4111/entry/blog-engine-updates-markdown-preprocessor-fay-scripts/index.html"><meta name="twitter:card" content="summary"><meta name="twitter:creator:id" content="mstk"><link rel="author" href="https://plus.google.com/107705320197444500140"><link rel="alternate" type="application/rss+xml" title="in Code (RSS Feed)" href="/"><link rel="canonical" href="http://home.jle0.com:4111/entry/blog-engine-updates-markdown-preprocessor-fay-scripts/index.html"><link href="/favicon.ico" rel="shortcut icon"><link href="/css/toast.css" rel="stylesheet" type="text/css"><link href="/css/font.css" rel="stylesheet" type="text/css"><link href="/css/main.css" rel="stylesheet" type="text/css"><link href="/css/page/entry.css" rel="stylesheet" type="text/css"><link href="/css/pygments.css" rel="stylesheet" type="text/css"><script type="text/javascript">var page_data = {};
var disqus_shortname='incode';
</script><script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5234d67a6b68dcd4"></script><script type="text/javascript" src="/js/common.js"></script><script type="text/javascript" src="/js/page/entry_toc.js"></script><script type="text/javascript" src="/ghcjs/blog-javascript-entry.jsexe/all.js"></script><script type="text/javascript" src="/js/disqus.js"></script><script type="text/javascript" src="/js/disqus_count.js"></script><script type="text/javascript" src="/js/social.js"></script><script type="text/javascript" src="/js/jquery/jquery.toc.js"></script></head><body><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-443711-8', 'jle.im');
ga('send', 'pageview');
</script><div id="fb-root"><script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=641852699171929";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</script></div><div id="header-container"><div id="navbar-container" class="tile"><nav id="navbar-content"><div class="nav-info"><h1 class="site-title"><a href="/" class="nav-title">in Code</a></h1><span class="nav-author">Justin Le</span></div><ul class="nav-links"><li><a href="/">home</a></li><li><a href="/entries">archives</a></li><div class="clear"></div></ul></nav></div><div id="header-content"></div></div><div id="body-container" class="container"><div id="main-container" class="grid"><div class="entry-section unit span-grid" role="main"><article class="tile article"><header><h1 id="title">Blog engine updates: Markdown Preprocessor &amp; Fay Scripts</h1><p class="entry-info">by <a class="author" href="/">Justin Le</a><span class="info-separator"> &diams; </span><time datetime="2014-01-27T01:03:38Z" pubdate="" class="pubdate">Monday January 27, 2014</time></p><p><span class="source-info"><a class="source-link" href="https://github.com/mstksg/inCode/tree/master/copy/entries/blog-pp-fay.md">Source</a><span class="info-separator"> &diams; </span><a class="source-link" href="http://home.jle0.com:4111/entry/blog-engine-updates-markdown-preprocessor-fay-scripts.md">Markdown</a><span class="info-separator"> &diams; </span><a class="source-link" href="http://home.jle0.com:4111/entry/blog-engine-updates-markdown-preprocessor-fay-scripts.tex">LaTeX</a><span class="info-separator"> &diams; </span></span>Posted in <a href="http://home.jle0.com:4111/entries/category/@meta" class="tag-a-category" title="Posts about this blog or blogging in general. So meta.">Meta</a><span class="info-separator"> &diams; </span><a class="comment-link" href="#disqus_thread">Comments</a></p></header><hr><aside class="contents-container"><h5 id="contents-header">Contents</h5><div id="toc"></div></aside><div class="main-content copy-content"><p>I spent some time over the past week writing a preprocessor for the entry copy markdowns and getting Fay to deploy some simple scripts.</p>
<p>The need for a preprocessor was sparked by a post I’m writing that sort of necessitated the features. I write <a href="https://github.com/mstksg/inCode/tree/master/copy/entries">all of my posts</a> in markdown, and it all integrated well with the preprocessor. In addition I needed some javascript scripting to make the preprocessor actions worthwhile, so I buckled down and wrestled with getting Fay to work in a production environment. So I guess this post is to show off some new features of the blog engine?</p>
<h2 id="demonstration">Demonstration</h2>
<p>Here it is in action:</p>
<pre><code>&gt; !!!monad-plus/WolfGoatCabbage.hs &quot;findSolutions ::&quot; &quot;makeMove ::&quot; wolf-goat-cabbage</code></pre>
<p>yields:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- source: https://github.com/mstksg/inCode/tree/master/code-samples/monad-plus/WolfGoatCabbage.hs#L28-45</span>
<span class="co">-- interactive: https://www.fpcomplete.com/user/jle/wolf-goat-cabbage</span>
<span class="ot">findSolutions ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> [<span class="dt">Plan</span>]
findSolutions n <span class="fu">=</span> <span class="kw">do</span>
    p <span class="ot">&lt;-</span> makeNMoves
    guard <span class="fu">$</span> isSolution p
    return p
    <span class="kw">where</span>
        makeNMoves <span class="fu">=</span> iterate (<span class="fu">&gt;&gt;=</span> makeMove) (return startingPlan) <span class="fu">!!</span> n

<span class="ot">makeMove ::</span> <span class="dt">Plan</span> <span class="ot">-&gt;</span> [<span class="dt">Plan</span>]
makeMove p <span class="fu">=</span> <span class="kw">do</span>
    next <span class="ot">&lt;-</span> <span class="dt">MoveThe</span> <span class="fu">&lt;$&gt;</span> [<span class="dt">Farmer</span> <span class="fu">..</span>]
    guard       <span class="fu">$</span> moveLegal p next
    guard <span class="fu">.</span> not <span class="fu">$</span> moveRedundant p next
    <span class="kw">let</span>
        p&#39; <span class="fu">=</span> p <span class="fu">++</span> [next]
    guard <span class="fu">$</span> safePlan p&#39;
    return p&#39;</code></pre></div>
<p>(If you’re reading this on the actual website, mouse over or click them to see the full effect, or if nothing is happening, try a hard refresh — CTRL+SHIFT+R in Chrome — to clear out the cache)</p>
<h2 id="code-quotinglinking-preprocessor">Code quoting/linking preprocessor</h2>
<p>So I find myself writing a lot of sample code for my posts, and then later copying and pasting them over to the <a href="https://github.com/mstksg/inCode/tree/master/code-samples">code-samples</a> directory on the github in order to allow people to download them…and then later awkwardly putting a link saying “download these here!” afterwards and taking up space. Also linking to a live <a href="https://www.fpcomplete.com/">FPComplete</a> version is a bit awkward too, right after the block.</p>
<p>I was rather inspired by the interface on the code blocks for <a href="http://weblog.luite.com/wordpress/?p=127">luite’s blog</a>, where every relevant code block has a little link box on the top right hand corner linking to the source and a working/running example.</p>
<p>So I wrote a Haskell preprocessor to take in a specification of a code file and a what blocks in the code file to load, and then load it into the markdown file before it is processed by pandoc.</p>
<p>The syntax is:</p>
<pre><code>&gt; !!!path/to/code &quot;keyword&quot; &quot;limited&quot;n live_link</code></pre>
<p>Where “keyword” is the text in the line to match for, <code>n</code> is the number of lines after the keyword to display (if left off, it takes the next “block”, or the next continuous piece of code before a new non-indented line), and <code>live_link</code> is a link to the live/interactive version on FPComplete.</p>
<h3 id="reflections">Reflections</h3>
<p>So…writing the parser for the syntax specification was pretty easy due to parsec and parser combinators:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- source: https://github.com/mstksg/inCode/tree/master/code-samples/source/EntryPP.hs#L32-127</span>
<span class="kw">data</span> <span class="dt">SampleSpec</span> <span class="fu">=</span> <span class="dt">SampleSpec</span>  {<span class="ot"> sSpecFile       ::</span> FilePath
                              , _<span class="ot">sSpecLive      ::</span> <span class="dt">Maybe</span> <span class="dt">String</span>
                              , _<span class="ot">sSpecKeywords  ::</span> [(<span class="dt">String</span>,<span class="dt">Maybe</span> <span class="dt">Int</span>)]
                              } <span class="kw">deriving</span> (<span class="dt">Show</span>)

<span class="ot">sampleSpec ::</span> <span class="dt">Parser</span> <span class="dt">SampleSpec</span>
sampleSpec <span class="fu">=</span> <span class="kw">do</span>
    filePath <span class="ot">&lt;-</span> noSpaces <span class="fu">&lt;?&gt;</span> <span class="st">&quot;sample filePath&quot;</span>
    spaces
    keywords <span class="ot">&lt;-</span> many <span class="fu">$</span> <span class="kw">do</span>
      keyword <span class="ot">&lt;-</span> char <span class="ch">&#39;&quot;&#39;</span> <span class="fu">*&gt;</span> manyTill anyChar (char <span class="ch">&#39;&quot;&#39;</span>) <span class="fu">&lt;?&gt;</span> <span class="st">&quot;keyword&quot;</span>
      keylimit <span class="ot">&lt;-</span> optionMaybe (read <span class="fu">&lt;$&gt;</span> many1 digit <span class="fu">&lt;?&gt;</span> <span class="st">&quot;keyword limit&quot;</span>)
      spaces
      return (keyword,keylimit)

    live <span class="ot">&lt;-</span> optionMaybe noSpaces <span class="fu">&lt;?&gt;</span> <span class="st">&quot;live url&quot;</span>
    <span class="kw">let</span>
      live&#39; <span class="fu">=</span> mfilter (not <span class="fu">.</span> null) live

    return <span class="fu">$</span> <span class="dt">SampleSpec</span> filePath live&#39; keywords
  <span class="kw">where</span>
    noSpaces <span class="fu">=</span> manyTill anyChar (space <span class="fu">&lt;|&gt;</span> <span class="ch">&#39; &#39;</span> <span class="fu">&lt;$</span> eof)</code></pre></div>
<p>The code to actually find the right code block to paste was complicated and horrifying at first, but after I sat down and really sorted out the logic, it wasn’t too bad. Still, it isn’t the cleanest code in the world and I wonder how I could have made it better, either with a Haskell library or even another language.</p>
<p>This all left two little comment lines before the source code insert with the link to the source and interactive versions.</p>
<p>All that was left was a front-end script to get the comments and turn them into floating divs.</p>
<h2 id="fay">Fay</h2>
<p>Ah okay, here was the fun part.</p>
<p>Fay is actually pretty fun to use. And while it was perhaps complete overkill to use the entire Fay runtime and build system for just a simple script, but I was pretty inspired by <a href="http://ocharles.org.uk/blog/posts/2013-12-23-24-days-of-hackage-fay.html">ocharles’s post on fay</a> and I thought this would be a good time to get to learn it.</p>
<p>So there was a lot of cognitive friction going in, and trying to really get in the groove took a few days. There was also a rather unhelpful error message involving the ffi that I was able to bring up to the maintainers and be a part of getting the fix working.</p>
<p>I converted as much of my current scripts as I could to fay. There was one that I couldn’t — a function call to a library that required a javascript object of function callbacks, and I couldn’t really get that to work cleanly and I decided it wasn’t worth the effort for now — maybe another day. If anything I could re-write the entire library (a Table of Contents generator) myself some day.</p>
<h3 id="reflections-1">Reflections</h3>
<h4 id="fay-jquery">fay-jquery</h4>
<p>Here is a characteristic example of fay code with <a href="http://hackage.haskell.org/package/fay-jquery-0.6.0.2">fay-jquery</a> (0.6.0.2):</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- source: https://github.com/mstksg/inCode/tree/master/code-samples/source/entry.hs#L45-54</span>
<span class="ot">appendTopLinks ::</span> <span class="dt">Fay</span> ()
appendTopLinks <span class="fu">=</span> <span class="kw">do</span>
  mainContent <span class="ot">&lt;-</span> select <span class="st">&quot;.main-content&quot;</span>
  headings <span class="ot">&lt;-</span> childrenMatching <span class="st">&quot;h2,h3,h4,h5&quot;</span> mainContent
  J.append topLink headings
  topLinks <span class="ot">&lt;-</span> select <span class="st">&quot;.top-link&quot;</span>
  click (scrollTo <span class="dv">400</span>) topLinks
  return ()
  <span class="kw">where</span>
    topLink <span class="fu">=</span> <span class="st">&quot;&lt;a href=&#39;#title&#39; class=&#39;top-link&#39;&gt;top&lt;/a&gt;&quot;</span></code></pre></div>
<p>As you can see, some of the method calls in fay-jquery seem a bit backwards…I had to resist the urge to write things like</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">container <span class="ot">`append`</span> contained
container <span class="ot">`childrenMatching`</span> <span class="st">&quot;.contained&quot;</span></code></pre></div>
<p>Which matches the JQuery calling model:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="va">container</span>.<span class="at">append</span>(contained)<span class="op">;</span>
<span class="va">container</span>.<span class="at">children</span>(<span class="st">&#39;.contained&#39;</span>)<span class="op">;</span></code></pre></div>
<p>Unfortunately, this doesn’t work, and you’re supposed to reverse the order of the parameters. I guess it is more Haskell-y in a way, to be able to play with partial application and do something like</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">let</span>
  appendIt <span class="fu">=</span> append container
<span class="kw">in</span>
  appendIt contained1
  appendIt contained2
  appendIt contained3</code></pre></div>
<p>So I guess that’s okay.</p>
<p>However, something I was less understanding of was the ordering for event binding and loops, which needed the handlers <em>before</em> the object being binded.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">flip click header <span class="fu">$</span> \_ <span class="ot">-&gt;</span> <span class="kw">do</span>
  toggled <span class="ot">&lt;-</span> readFayRef sourceToggled
  <span class="kw">if</span> toggled
    <span class="kw">then</span> sHide sourceInfo
    <span class="kw">else</span> unhide sourceInfo
  modifyFayRef&#39; sourceToggled Prelude.not</code></pre></div>
<p>This one kind of bucks the convention that methods like <code>append</code> maintain…and also needs those annoying <code>flips</code> to have easy anonymous callbacks. I don’t want to have to name every little thing. Oh well. Maybe there is a good justification here? I just don’t see it. But then again, there is a reason why we have both <code>mapM</code> and <code>forM</code> in base.</p>
<p>Other than that, the fay-jquery library is a pretty good example of how to interface seamlessly with JQuery from Fay. Sometimes, though, the dynamic nature of JQuery (implicit lists, dynamic type of returns, etc) was a little unsettling…but that’s the nature of JQuery. Perhaps working directly with the DOM would alleviate this — there’s <a href="http://hackage.haskell.org/package/fay-dom">fay-dom</a> out there, but I didn’t get a chance to give it a try.</p>
<h4 id="deploying-fay">Deploying fay</h4>
<p>Deploying fay ain’t all too bad. I <a href="http://blog.jle.im/entry/deploying-medium-to-large-haskell-apps-to-heroku">deploy binaries</a>, however, so I was unable to ever process fay on my limited-access production server because it requires <code>ghc-pkg</code> (installed under <code>/usr/local/bin</code>) among other things…I probably could have gotten this to work, but I did not have the proper skills. You also need to provide the binaries and headers in <code>share</code> for all of your fay libraries in order to use them when compiling to javascript. So while this isn’t so bad if you have the whole Haskell Platform and are compiling on your production server, I had to pre-compile my fay “binaries” before pushing…just like I have to pre-compile my regular binaries, interestingly enough.</p>
<p>Of course, the fay javascript files were a bit larger than the normal javascript ones. Not too significantly, though, only about 80x. This actually puts them however at around the size of my image files (~100KB)…this is slightly worrisome, but I don’t really stress too much about one image, so I guess I shouldn’t stress too much about this either. Not ideal, but what else could I expect?</p>
<h2 id="future-stuff">Future stuff</h2>
<p>Hopefully I’m able to make <a href="http://blog.jle.im/source/code-samples/source/entry_toc.js#L4-21">that javascript call</a> on fay one day, without having to rewrite the entire library in Fay (although it might be a fun exercise).</p>
<!-- ~~~javascript -->
<!-- !!!source/entry_toc.js "#toc"18 -->
<!-- ~~~ -->
<p>If anyone knows how I can do this, I’d really appreciate any help!</p>
<p>I’d also in the future like to make my preprocessor a bit more robust and also take more languages to determine the right comment syntax. But…I probably wouldn’t do this until the need actually arises :)</p></div><footer><ul class="entry-series"></ul><ul class="tag-list"><li><a href="http://home.jle0.com:4111/entries/tagged/fay" class="tag-a-tag">#fay</a></li><li><a href="http://home.jle0.com:4111/entries/tagged/haskell" class="tag-a-tag">#haskell</a></li><li><a href="http://home.jle0.com:4111/entries/category/@meta" class="tag-a-category">@META</a></li></ul><aside class="social-buttons"><div class="addthis_toolbox addthis_default_style addthis-buttons"><a class="addthis_button_facebook_like" fb:like:layout="button_count"></a><a class="addthis_button_tweet"></a><a class="addthis_button_google_plusone" g:plusone:size="medium"></a><a class="addthis_counter addthis_pill_style"></a></div><div class="custom-social-buttons"><div class="custom-social-button"><su:badge layout="1"></su:badge></div><div class="custom-social-button"><a href="http://www.reddit.com/submit" onclick="window.location = &#39;http://www.reddit.com/submit?url=&#39;+ encodeURIComponent(window.location); return false"><img src="http://www.reddit.com/static/spreddit7.gif" alt="submit to reddit"></a></div></div></aside><nav class="next-prev-links"><ul><li class="next-entry-link">(Next) <a href="http://home.jle0.com:4111/entry/fixed-length-vector-types-in-haskell-2015">Fixed-Length Vector Types in Haskell, 2015</a> &rarr;</li></ul></nav></footer></article><div class="post-entry"><div class="tile"><div id="disqus_thread"></div><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a><br></noscript><a href="http://disqus.com" class="dsq-brlink">Comments powered by <span class="logo-disqus">Disqus</span></a></div></div></div></div></div><div id="footer-container"><div id="footer-content"><div class="tile"><div class="footer-copyright">&copy; 2016 Justin Le</div><div class="footer-follow social-follows"><ul class="social-follows-list"><li><ul class="social-follows-list-social"><li><a class="social-follow-facebook" title="Friend me on Facebook!" href="https://facebook.com/mstksg">Facebook</a></li><li><a class="social-follow-twitter" title="Follow me on Twitter!" href="https://twitter.com/intent/user?user_id=mstk" onclick="window.open(
  &#39;http://twitter.com/intent/user?user_id=907281&#39;,
  &#39;facebook-share-dialog&#39;,
  &#39;width=550,height=520&#39;);
return false;
">Twitter</a></li><li><a class="social-follow-gplus" title="Add me on Google+!" href="https://plus.google.com/+JustinLe">Google+</a></li><li><a class="social-follow-linkedin" title="Connect with me on LinkedIn!" href="https://linkedin.com/in/mstksg">LinkedIn</a></li><li><a class="social-follow-github" title="Fork me on Github!" href="https://github.com/lejustin">Github</a></li></ul></li><li><ul class="social-follows-list-site"><li><a class="social-follow-rss" title="Subscribe to my RSS Feed!" href="http://feeds.feedburner.com/incodeblog">RSS</a></li><li><a class="social-follow-email" title="Subscribe to the mailing list!" href="https://feedburner.google.com/fb/a/mailverify?loc=en_US&amp;uri=incodeblog">Mailing list</a></li></ul></li></ul></div></div></div></div></body></html>