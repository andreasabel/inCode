<!DOCTYPE HTML>
<html><head><title>Blog Rewrite with Hakyll and Purescript · in Code</title><meta name="description" content="Weblog of Justin Le, covering his various adventures in programming and explorations in the vast worlds of computation physics, and knowledge."><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><meta property="og:site_name" content="in Code"><meta property="og:description" content="It’s been almost a year since my last post! Things have been a bit hectic with research and related things, and with the unrelenting academia publishing cycle, any time I can get to write or explore has been a nice escape. Admittedly, I’ve also run into some friction updating my blog because it was a compiled web server with some delicate dependencies and required environment configuration to build/deploy. It was written/built at a time when a lot of the infrastructure we have now in the Haskell ecosystem either wasn’t there, or wasn’t mature. We didn’t have easy Heroku deployment, and we didn’t have great tools like stack to let us create reproducible builds. One of my first posts in 2013 was actually about hoops to jump through just to get a simple Heroku deployment. I’ve had to maintain a virtual machine just to compile and push changes! My blog was one of my first Haskell projects ever, and if I had started it now, in 2016, things would definitely be a bit different. By this point, it’s been long enough and the slight inconveniences have been building up enough that I thought it’d be time to sit down and finally migrate my first large-ish Haskell project and bring it into modern times, by using hakyll and purescript. Here are my thoughts and observations on how the migration went, with insight on Haskell migrations in general! My blog engine is open-source, and the source for this specific instance is up on github, for those interesting in checking it out!"><meta property="og:type" content="article"><meta property="og:title" content="Blog Rewrite with Hakyll and Purescript"><meta property="og:image" content="https://blog.jle.im/img/site_logo.jpg"><meta property="og:locale" content="en_US"><meta property="og:url" content="https://blog.jle.im/entry/blog-rewrite-with-hakyll-and-purescript.html"><meta name="twitter:card" content="summary"><meta name="twitter:creator:id" content="mstk"><link rel="author" href="https://plus.google.com/107705320197444500140"><link rel="alternate" type="application/rss+xml" title="in Code (RSS Feed)" href="http://feeds.feedburner.com/incodeblog"><link rel="canonical" href="https://blog.jle.im/entry/blog-rewrite-with-hakyll-and-purescript.html"><link href="https://blog.jle.im/favicon.ico" rel="shortcut icon"><link href="https://blog.jle.im/css/toast.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/font.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/main.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/page/entry.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/pygments.css" rel="stylesheet" type="text/css"><script type="text/javascript">var page_data = {};
var disqus_shortname='incode';
</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-443711-8', 'jle.im');
ga('send', 'pageview');
</script><script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5234d67a6b68dcd4"></script><script type="text/javascript" src="https://blog.jle.im/js/common.js"></script><script type="text/javascript" src="https://blog.jle.im/js/page/entry_toc.js"></script><script type="text/javascript" src="https://blog.jle.im/js/disqus_count.js"></script><script type="text/javascript" src="https://blog.jle.im/js/social.js"></script><script type="text/javascript" src="https://blog.jle.im/js/jquery/jquery.toc.js"></script><script type="text/javascript" src="https://blog.jle.im/purescript/entry.js"></script></head><body><div id="fb-root"><script>(function(d, s, id) {
 var js, fjs = d.getElementsByTagName(s)[0];
 if (d.getElementById(id)) return;
 js = d.createElement(s); js.id = id;
 js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=641852699171929";
 fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</script></div><div id="header-container"><div id="navbar-container" class="tile"><nav id="navbar-content"><div class="nav-info"><h1 class="site-title"><a href="https://blog.jle.im/" class="nav-title">in Code</a></h1><span class="nav-author">Justin Le</span></div><ul class="nav-links"><li><a href="https://blog.jle.im/">home</a></li><li><a href="https://blog.jle.im/entries.html">archives</a></li><div class="clear"></div></ul></nav></div><div id="header-content"></div></div><div id="body-container" class="container"><div id="main-container" class="grid"><div class="entry-section unit span-grid" role="main"><article class="tile article"><header><h1 id="title">Blog Rewrite with Hakyll and Purescript</h1><p class="entry-info">by <a class="author" href="https://blog.jle.im/">Justin Le</a><span class="info-separator"> &diams; </span><time datetime="2016-03-25T08:59:18Z" pubdate="" class="pubdate">Friday March 25, 2016</time></p><p><span class="source-info"><a class="source-link" href="https://github.com/mstksg/inCode/tree/master/copy/entries/hakyll-rewrite.md">Source</a><span class="info-separator"> &diams; </span><a class="source-link" href="https://blog.jle.im/entry/blog-rewrite-with-hakyll-and-purescript.md">Markdown</a><span class="info-separator"> &diams; </span><a class="source-link" href="https://blog.jle.im/entry/blog-rewrite-with-hakyll-and-purescript.tex">LaTeX</a><span class="info-separator"> &diams; </span></span>Posted in <a href="https://blog.jle.im/entries/category/@meta.html" class="tag-a-category" title="Posts about this blog or blogging in general. So meta.">Meta</a><span class="info-separator"> &diams; </span><a class="comment-link" href="#disqus_thread">Comments</a></p></header><hr><aside class="contents-container"><h5 id="contents-header">Contents</h5><div id="toc"></div></aside><div class="main-content copy-content"><p>It’s been almost a year since my last post! Things have been a bit hectic with research and related things, and with the unrelenting academia publishing cycle, any time I can get to write or explore has been a nice escape.</p>
<p>Admittedly, I’ve also run into some friction updating my blog because it was a compiled web server with some delicate dependencies and required environment configuration to build/deploy. It was written/built at a time when a lot of the infrastructure we have now in the Haskell ecosystem either wasn’t there, or wasn’t mature. We didn’t have easy <a href="https://haskellonheroku.com/">Heroku deployment</a>, and we didn’t have great tools like <a href="http://haskellstack.org/">stack</a> to let us create reproducible builds. One of my <a href="http://blog.jle.im/entry/deploying-medium-to-large-haskell-apps-to-heroku.html">first posts</a> in 2013 was actually about hoops to jump through <em>just</em> to get a simple Heroku deployment. I’ve had to maintain a virtual machine just to compile and push changes!</p>
<p>My blog was one of my first Haskell projects ever, and if I had started it now, in 2016, things would definitely be a bit different. By this point, it’s been long enough and the slight inconveniences have been building up enough that I thought it’d be time to sit down and finally migrate my “first large-ish Haskell project” and bring it into modern times, by using <a href="https://jaspervdj.be/hakyll/">hakyll</a> and <a href="http://www.purescript.org/">purescript</a>. Here are my thoughts and observations on how the migration went, with insight on Haskell migrations in general!</p>
<p>My blog engine is open-source, and the <a href="https://github.com/mstksg/inCode">source for this specific instance</a> is up on github, for those interesting in checking it out!</p>
<h2 id="hakyll">Hakyll</h2>
<p>To be fair, there was little actual practical reasons why my site wasn’t static to begin with. The main reason, feature-wise, was for me to be able to schedule blog posts and updates without requiring me to actually re-render and re-push every time I wanted to make a post. The real underlying reason, however, was that this blog was my first major Haskell project, and I wanted to take the opportunity to be able to learn how to interface with databases in Haskell.</p>
<p>Now that that learning impetus is behind me, I felt free to throw it all out the window and rewrite things to be a completely 100% static site!</p>
<p><a href="https://jaspervdj.be/hakyll/">Hakyll</a> was great; it’s basically like a very specialized <em>make</em>-like tool for building sites. It takes a bit of time to get used to “thinking in Hakyll” — generating standalone pages instead of just ones based off of files, getting used to the identifier/snapshot system — but once you do, things go pretty smoothly. I started thinking about snapshots as customized “object files” that you can leave behind in the process of creating pages that other pages can use. Hakyll manages all the dependencies for you, so pages that depend on the things left from other pages will be sequenced properly, and rebuilding your website only requires rebuilding pages that depend on files you changed. Neat!</p>
<p>Before, I had gotten the impression that Hakyll was mostly for generating “simple”, pre-built blog layouts, but I was able to use Hakyll (without much friction, at all) to generate the complex, intricate, and arbitrary site map that I had designed for my scotty-based blog. I definitely recommend it for any static site generating needs, blogs or not.</p>
<p>An unexpected consequence of the static-site-hosted-by-github-pages approach, however, is that I don’t have any control over MIME types anymore (or 301 redirects), so I had to do some migrations to move pages over to “.html” and set up redirects and stuff (and get redirects to work with google analytics), but those were made super simple with Hakyll.</p>
<h2 id="refactoring-haskell-code">Refactoring Haskell Code</h2>
<p>One thing that did not disappoint me was how <em>easy</em> and <em>painless</em> it is to refactor Haskell code. This is something I always trumpet/brag about Haskell, and getting the opportunity to actually refactor a major-ish codebase.</p>
<p>And, yes, I was not disappointed! For the most part, I already had my html templates, CSS, static javascript, etc. in place. All of the mechanisms were extremely modular and very easy to port. The type system made sure everything fit together well at the boundaries. They also instantly told me what did what, and ensured that sweeping changes in my code were safe. The “if it compiles, it works” mantra served me greatly here. I can’t even begin to imagine migrating one of my old ruby projects in the same way. With this, I was confident that my compiled code was correct and did what I wanted. The types were a guide and also a avenue of insight into my 3-years-removed past self.</p>
<p>Thanks to the types, I was able to pick up something I hadn’t touched in 3 years, figure out how all things fit together, and completely gut everything apart and use them for a new build system … with compile-time assurances that I didn’t do anything incorrectly!</p>
<p>It’s hard for me to really explain how amazing the feeling of refactoring Haskell code is. I used to dread refactors and migrations, but now I look forward to them and find any opportunity to do one! :D It’s something that’s difficult to convey the sublime joy of until you actually try it, so I recommend trying it some day :)</p>
<h2 id="purescript">Purescript</h2>
<h3 id="on-fay">on Fay</h3>
<p>With my <a href="http://blog.jle.im/entry/blog-engine-updates-markdown-preprocessor-fay-scripts.html#fay">last major blog update</a>, I ported all of my one-off javascript scripts to fay. This time around, I figured I’d move away from <a href="https://github.com/faylang/fay/wiki">fay</a>, because it was slightly clunky to build/get working/integrate in the way that GHCJS spoiled me to be accustomed to. In the future, I might return … but at this point in time, Fay seems a bit awkward in the ecosystem. GHCJS lets you use the full power of Haskell (including all of <em>base</em>’s concurrency mechanisms and almost every library on hackage), at the expense of creating large and unreadable javascript blobs.</p>
<p>Fay seemed like just a <em>weaker</em> GHCJS to me, but in all the ways that mattered. It doesn’t have all of the awesome GHC things that make modern Haskell what it is (not just the lack of base’s identical API, but also … no typeclasses? Lens abstactions? Hackage libraries?), so almost all of my normal Haskell programming flow is thrown out the window. It’s a subset of Haskell, but lacks most of the tools people use to write <em>actual</em> Haskell like they’d write everyday. The generated javascript blobs are still decently opaque.</p>
<p>So, if you’re going to be spending your time writing something that is like Haskell, but forces you to write it in a way that is nothing like any actual Haskell code you’d normally write… why even bother keeping up with Haskell semantics and Haskell compatibility? Why not break out and try something new and fresh, unbound by Haskell and compatibility issues?<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a><a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a></p>
<h3 id="on-purescript">on Purescript</h3>
<p>With that mindset, I looked at <em><a href="http://www.purescript.org/">purescript</a></em>, which is a language that’s inspired by Haskell, with a lot of Haskell features we use every day, and throws in things we all wish we had in Haskell, like extensible records!</p>
<p>(Fair note — I did rewrite all of my fay in GHCJS at first. This resulted in a javascript blob that was <em>1.4 MB</em> in size, for a bunch of small DOM manipulation scripts. Definitely not practical, unfortunately!)</p>
<p>I liked that purescript was able to throw away a lot of warts in the Haskell ecosystem, with a cleaner typeclass hierarchy and just a lot of design decisions “done right”, that we’d all change in Haskell if we could. And extensible records being built into the language is quite refreshing; not having to deal with fancy GADT’s in Haskell was a nice step back from the craziness that is type-level programming in Haskell. Alongside all of that, I was also able to rely and seamlessly use a lot of Haskell idioms that we all know and love, like lenses and traversals and compositions.</p>
<p>At many moments, I felt like writing in Purescript felt like writing in <em>the language that Haskell should have been</em>.</p>
<p>But one of my favorite aspects about purescript ended up being the sheer beauty and conciseness of the generated javascript. Look at how<a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a>:</p>
<pre class="purescript"><code>appendTopLinks doc = do
    hs &lt;- querySelectorAll headers (documentToParentNode doc)
    flip traverseNodeList_ hs \h -&gt; do
      topLink &lt;- createElement &quot;a&quot; doc
      let topLinkNode = elementToNode topLink
      setAttribute &quot;href&quot; &quot;#title&quot; topLink
      setClassName &quot;top-link&quot; topLink
      setTextContent &quot;top&quot; topLinkNode
      appendChild topLinkNode (elementToNode h)
      return unit</code></pre>
<p>gets translated to:</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> appendTopLinks <span class="op">=</span> <span class="kw">function</span> (doc) <span class="op">{</span>
    <span class="cf">return</span> <span class="kw">function</span> <span class="at">__do</span>() <span class="op">{</span>
        <span class="kw">var</span> v <span class="op">=</span> <span class="at">querySelectorAll</span>(headers)(<span class="at">documentToParentNode</span>(doc))()<span class="op">;</span>
        <span class="cf">return</span> <span class="at">flip</span>(<span class="at">traverseNodeList_</span>(monadEffEff))(v)(<span class="kw">function</span> (h) <span class="op">{</span>
            <span class="cf">return</span> <span class="kw">function</span> <span class="at">__do</span>() <span class="op">{</span>
                <span class="kw">var</span> v1 <span class="op">=</span> <span class="at">createElement</span>(<span class="st">&quot;a&quot;</span>)(doc)()<span class="op">;</span>
                <span class="kw">var</span> topLinkNode <span class="op">=</span> <span class="at">elementToNode</span>(v1)<span class="op">;</span>
                <span class="at">setAttribute</span>(<span class="st">&quot;href&quot;</span>)(<span class="st">&quot;#title&quot;</span>)(v1)()<span class="op">;</span>
                <span class="at">setClassName</span>(<span class="st">&quot;top-link&quot;</span>)(v1)()<span class="op">;</span>
                <span class="at">setTextContent</span>(<span class="st">&quot;top&quot;</span>)(topLinkNode)()<span class="op">;</span>
                <span class="at">appendChild</span>(topLinkNode)(<span class="at">elementToNode</span>(h))()<span class="op">;</span>
                <span class="cf">return</span> unit<span class="op">;</span>
            <span class="op">};</span>
        <span class="op">}</span>)()<span class="op">;</span>
    <span class="op">};</span>
<span class="op">};</span></code></pre></div>
<p>And it’s not just the IO-based imperative code that looks nice, too. Everything gets compiled to clean, readable javascript that you’d be happy to import in your node or normal javascript project.</p>
<p>The total exported javascript blob is only <em>88 kB</em>, even smaller than fay’s <em>100 kB</em> output (but not significantly so), and much smaller than GHCJS’s <em>1.4 MB</em><a href="#fn4" class="footnoteRef" id="fnref4"><sup>4</sup></a> output (which has to also contain the entire Haskell runtime, implementing Haskell semantics, as well).</p>
<p>Interestingly enough, the <em>original</em> raw javacript I wrote in 2013 came out to about the same size, about <em>80 kB</em>. (Well, it is about <em>2 kB</em> of actual script, but it utilized all of <em>jquery</em>, which implements a lot of the functionality.) Getting comparable filesizes to jquery bundles is something that’s pretty impressive to me!</p>
<p>I’d recommend purescript to anyone who has to write simple javascript <em>scripts</em> and wants to do it in a sane, beautiful language. I still use <em>ghcjs</em> for actual <em>applications</em>, for now, because I still love Haskell and its ecosystem, along with the free data type sharing and code re-usage. But for small scripts like these, purescript might just be the ideal and perfect solution!</p>
<p>You can check out <a href="https://github.com/mstksg/inCode/blob/28f6a5da4c83356c4be87067ab88171879c68784/app-purescript/Entry.purs">the actual purescript script</a> on github!</p>
<h2 id="conclusions">Conclusions</h2>
<p>My main takeways —</p>
<ol type="1">
<li>I will never be able to never work on a Haskell project/application without <em>stack</em> again (how did we even survive before <em>stack</em>?)</li>
<li>Hakyll is a fun little library that is a great specialized <em>make</em> for building static websites</li>
<li>Refactoring Haskell is an amazing experience; I would recommend it to anyone to try it out at least once in their lives</li>
<li><em>Purescript</em> is an amazing and beautiful technology that I had the pleasure of learning during this process, and generates elegant, readable javascript scripts.</li>
</ol>
<p>This reflection post has been to help me organize my thoughts, but I hope they can be useful for those of you looking for new technologies to learn and ways to implement/approach your stack or next programming project, as well!</p>
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p>I definitely don’t mean to bash on <em>fay</em> here! It definitely has its role and place in the ecosystem. It’s for my specific application that I was looking for an alternative with.<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>There’s another thing here that I skipped over slightly – <a href="http://haste-lang.org/">Haste</a>. I haven’t had much experience with it myself, but for this purpose, I decided to jump into something not-Haskell and try out something new!<a href="#fnref2">↩</a></p></li>
<li id="fn3"><p>Unfortunately, <em><a href="https://github.com/jgm/highlighting-kate">highlighting-kate</a></em> doesn’t yet support purescript syntax highlighting?<a href="#fnref3">↩</a></p></li>
<li id="fn4"><p>A previous version of this post claimed that the javascript bundle was <em>140 MB</em>, instead of <em>1.4 MB</em>. My bad!<a href="#fnref4">↩</a></p></li>
</ol>
</section></div><footer><ul class="entry-series"></ul><ul class="tag-list"><li><a href="https://blog.jle.im/entries/tagged/hakyll.html" class="tag-a-tag">#hakyll</a></li><li><a href="https://blog.jle.im/entries/tagged/haskell.html" class="tag-a-tag">#haskell</a></li><li><a href="https://blog.jle.im/entries/tagged/purescript.html" class="tag-a-tag">#purescript</a></li><li><a href="https://blog.jle.im/entries/category/@meta.html" class="tag-a-category">@META</a></li></ul><aside class="social-buttons"><div class="addthis_toolbox addthis_default_style addthis-buttons"><a class="addthis_button_facebook_like" fb:like:layout="button_count"></a><a class="addthis_button_tweet"></a><a class="addthis_button_google_plusone" g:plusone:size="medium"></a><a class="addthis_counter addthis_pill_style"></a></div><div class="custom-social-buttons"><div class="custom-social-button"><a href="https://www.reddit.com/submit" onclick="window.location = &#39;https://www.reddit.com/submit?url=&#39;+ encodeURIComponent(window.location); return false"><img src="https://www.reddit.com/static/spreddit7.gif" alt="submit to reddit"></a></div></div></aside><nav class="next-prev-links"><ul><li class="prev-entry-link">&larr; <a href="https://blog.jle.im/entry/introducing-the-prompt-library.html">Introducing the “Prompt” library</a> (Previous)</li></ul></nav></footer></article><div class="post-entry"><div class="tile"><div id="disqus_thread"></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://blog.jle.im/entry/blog-rewrite-with-hakyll-and-purescript.html';
    this.page.identifier = 'hakyll-rewrite';
};
(function() {
    var d = document, s = d.createElement('script');
    s.src = '//incode.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a><br></noscript><a href="http://disqus.com" class="dsq-brlink">Comments powered by <span class="logo-disqus">Disqus</span></a></div></div></div></div></div><div id="footer-container"><div id="footer-content"><div class="tile"><div class="footer-copyright">&copy; 2016 Justin Le</div><div class="footer-follow social-follows"><ul class="social-follows-list"><li><ul class="social-follows-list-social"><li><a class="social-follow-facebook" title="Friend me on Facebook!" href="https://facebook.com/mstksg">Facebook</a></li><li><a class="social-follow-twitter" title="Follow me on Twitter!" href="https://twitter.com/intent/user?user_id=mstk" onclick="window.open(
  &#39;http://twitter.com/intent/user?user_id=907281&#39;,
  &#39;facebook-share-dialog&#39;,
  &#39;width=550,height=520&#39;);
return false;
">Twitter</a></li><li><a class="social-follow-gplus" title="Add me on Google+!" href="https://plus.google.com/+JustinLe">Google+</a></li><li><a class="social-follow-linkedin" title="Connect with me on LinkedIn!" href="https://linkedin.com/in/lejustin">LinkedIn</a></li><li><a class="social-follow-github" title="Fork me on Github!" href="https://github.com/mstksg">Github</a></li><li><a class="social-follow-keybase" title="Track me on Keybase!" href="https://keybase.io/mstksg">Keybase</a></li><li><a class="social-follow-bitcoin" title="Donate via bitcoin!" href="https://coinbase.com/mstksg">Bitcoin</a></li></ul></li><li><ul class="social-follows-list-site"><li><a class="social-follow-rss" title="Subscribe to my RSS Feed!" href="http://feeds.feedburner.com/incodeblog">RSS</a></li><li><a class="social-follow-email" title="Subscribe to the mailing list!" href="https://feedburner.google.com/fb/a/mailverify?loc=en_US&amp;uri=incodeblog">Mailing list</a></li></ul></li></ul></div></div></div></div></body></html>