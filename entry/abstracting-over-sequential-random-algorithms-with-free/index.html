<!DOCTYPE HTML>
<html><head><title>Abstracting over Sequential Random Algorithms with Free · in Code</title><meta name="description" content="Weblog of Justin Le, covering his various adventures in programming and explorations in the vast worlds of computation physics, and knowledge."><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><meta property="og:site_name" content="in Code"><meta property="og:description" content="It’s fair enough to say that I’m a little late to the free monad party, but I still think their power is greatly either misunderstood or underrated or obscure in Haskell, and this article will be my attempt to throw more examples of its usage. Here we’re going to construct a type that can represent sequential computations using randomness or entropy, and we’re going to abstract over our entropy source — not by swapping out the pseudorandom generator, but by really abstracting over what our computation really is to the barest essentials. We’re going to abstract over what an sequential random algorithm even is. The man plain is to first create a type that represents just a value produced from a random number…and then figure out how to chain them. -- source: https://github.com/mstksg/inCode/tree/master/code-samples/free-random/Rand.hs#L18-22 data RandF a where FromRandom :: Random r =&gt; ( r -&gt; a) -&gt; RandF a FromRandomR :: Random r =&gt; r -&gt; r -&gt; ( r -&gt; a) -&gt; RandF a FromRandoms :: Random r =&gt; ([r] -&gt; a) -&gt; RandF a FromRandomRs :: Random r =&gt; r -&gt; r -&gt; ([r] -&gt; a) -&gt; RandF a  For those of you unfamiliar with GADT syntax, this is just basically specifying a type by the type of its contructors; RandF has four constructors — one of which, FromRandom, takes a function (r -&gt; a), and returns a RandF a…as long as the r is an instance of the Random typeclass (from the random package). For comparison, Maybe could have been written like:"><meta property="og:type" content="article"><meta property="og:title" content="Abstracting over Sequential Random Algorithms with Free"><meta property="og:image" content="http://mstksg.github.com/inCode/img/site_logo.jpg"><meta property="og:locale" content="en_US"><meta property="og:url" content="http://mstksg.github.com/inCode/entry/abstracting-over-sequential-random-algorithms-with-free/index.html"><meta name="twitter:card" content="summary"><meta name="twitter:creator:id" content="mstk"><link rel="author" href="https://plus.google.com/107705320197444500140"><link rel="alternate" type="application/rss+xml" title="in Code (RSS Feed)" href="http://feeds.feedburner.com/incodeblog"><link rel="canonical" href="http://mstksg.github.com/inCode/entry/abstracting-over-sequential-random-algorithms-with-free/index.html"><link href="/favicon.ico" rel="shortcut icon"><link href="http://mstksg.github.com/inCode/css/toast.css" rel="stylesheet" type="text/css"><link href="http://mstksg.github.com/inCode/css/font.css" rel="stylesheet" type="text/css"><link href="http://mstksg.github.com/inCode/css/main.css" rel="stylesheet" type="text/css"><link href="http://mstksg.github.com/inCode/css/page/entry.css" rel="stylesheet" type="text/css"><link href="http://mstksg.github.com/inCode/css/pygments.css" rel="stylesheet" type="text/css"><script type="text/javascript">var page_data = {};
var disqus_shortname='incode';
</script><script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5234d67a6b68dcd4"></script><script type="text/javascript" src="http://mstksg.github.com/inCode/js/common.js"></script><script type="text/javascript" src="http://mstksg.github.com/inCode/js/page/entry_toc.js"></script><script type="text/javascript" src="http://mstksg.github.com/inCode/ghcjs/blog-javascript-entry.jsexe/all.js"></script><script type="text/javascript" src="http://mstksg.github.com/inCode/js/disqus.js"></script><script type="text/javascript" src="http://mstksg.github.com/inCode/js/disqus_count.js"></script><script type="text/javascript" src="http://mstksg.github.com/inCode/js/social.js"></script><script type="text/javascript" src="http://mstksg.github.com/inCode/js/jquery/jquery.toc.js"></script></head><body><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-443711-8', 'jle.im');
ga('send', 'pageview');
</script><div id="fb-root"><script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=641852699171929";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</script></div><div id="header-container"><div id="navbar-container" class="tile"><nav id="navbar-content"><div class="nav-info"><h1 class="site-title"><a href="http://mstksg.github.com/inCode/" class="nav-title">in Code</a></h1><span class="nav-author">Justin Le</span></div><ul class="nav-links"><li><a href="http://mstksg.github.com/inCode/">home</a></li><li><a href="http://mstksg.github.com/inCode/entries">archives</a></li><div class="clear"></div></ul></nav></div><div id="header-content"></div></div><div id="body-container" class="container"><div id="main-container" class="grid"><div class="entry-section unit span-grid" role="main"><article class="tile article"><header><div class="unposted-banner">Unposted entry</div><h1 id="title">Abstracting over Sequential Random Algorithms with Free</h1><p class="entry-info">by <a class="author" href="http://mstksg.github.com/inCode/">Justin Le</a></p><p><span class="source-info"><a class="source-link" href="https://github.com/mstksg/inCode/tree/master/copy/entries/free-random.md">Source</a><span class="info-separator"> &diams; </span><a class="source-link" href="http://mstksg.github.com/inCode/entry/abstracting-over-sequential-random-algorithms-with-free.md">Markdown</a><span class="info-separator"> &diams; </span><a class="source-link" href="http://mstksg.github.com/inCode/entry/abstracting-over-sequential-random-algorithms-with-free.tex">LaTeX</a><span class="info-separator"> &diams; </span></span>Posted in <a href="http://mstksg.github.com/inCode/entries/category/@haskell" class="tag-a-category" title="Functional, pure, non-strict, statically and strongly typed, natively
compiled…really just the king of great languages.">Haskell</a>, <a href="http://mstksg.github.com/inCode/entries/category/@projects" class="tag-a-category" title="Progress or presentations of completed or ongoing open source projects I
have worked/am working on. Hopefully either the development process or
the end product can be useful to someone!">Projects</a>, <a href="http://mstksg.github.com/inCode/entries/category/@ramblings" class="tag-a-category" title="My slight ramblings on subjects of interest (to me and hopefully to you
too!). Lots of surveys and introducts to new subjects.">Ramblings</a><span class="info-separator"> &diams; </span><a class="comment-link" href="#disqus_thread">Comments</a></p></header><hr><aside class="contents-container"><h5 id="contents-header">Contents</h5><div id="toc"></div></aside><div class="main-content copy-content"><p>It’s fair enough to say that I’m a little late to the free monad party, but I still think their power is greatly either misunderstood or underrated or obscure in Haskell, and this article will be my attempt to throw more examples of its usage.</p>
<p>Here we’re going to construct a type that can represent sequential computations using randomness or entropy, and we’re going to abstract over our entropy source — not by swapping out the pseudorandom generator, but by really abstracting over what our computation really <em>is</em> to the barest essentials. We’re going to abstract over what an sequential random algorithm even is.</p>
<p>The man plain is to first create a type that represents just a value produced from a random number…and then figure out how to chain them.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- source: https://github.com/mstksg/inCode/tree/master/code-samples/free-random/Rand.hs#L18-22</span>
<span class="kw">data</span> <span class="dt">RandF</span> a <span class="kw">where</span>
    <span class="dt">FromRandom</span><span class="ot">   ::</span> <span class="dt">Random</span> r <span class="ot">=&gt;</span>           ( r  <span class="ot">-&gt;</span> a) <span class="ot">-&gt;</span> <span class="dt">RandF</span> a
    <span class="dt">FromRandomR</span><span class="ot">  ::</span> <span class="dt">Random</span> r <span class="ot">=&gt;</span> r <span class="ot">-&gt;</span> r <span class="ot">-&gt;</span> ( r  <span class="ot">-&gt;</span> a) <span class="ot">-&gt;</span> <span class="dt">RandF</span> a
    <span class="dt">FromRandoms</span><span class="ot">  ::</span> <span class="dt">Random</span> r <span class="ot">=&gt;</span>           ([r] <span class="ot">-&gt;</span> a) <span class="ot">-&gt;</span> <span class="dt">RandF</span> a
    <span class="dt">FromRandomRs</span><span class="ot"> ::</span> <span class="dt">Random</span> r <span class="ot">=&gt;</span> r <span class="ot">-&gt;</span> r <span class="ot">-&gt;</span> ([r] <span class="ot">-&gt;</span> a) <span class="ot">-&gt;</span> <span class="dt">RandF</span> a</code></pre></div>
<p>For those of you unfamiliar with GADT syntax, this is just basically specifying a type by the type of its contructors; <code>RandF</code> has four constructors — one of which, <code>FromRandom</code>, takes a function <code>(r -&gt; a)</code>, and returns a <code>RandF a</code>…as long as the <code>r</code> is an instance of the <code>Random</code> typeclass (from the <em>random</em> package).</p>
<p>For comparison, <code>Maybe</code> could have been written like:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">data</span> <span class="dt">Maybe</span> a <span class="kw">where</span>
    <span class="dt">Just</span><span class="ot">    ::</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a
    <span class="dt">Nothing</span><span class="ot"> ::</span> <span class="dt">Maybe</span> a</code></pre></div>
<p>Anyways, every constructor is basically made with a function, “<em>If</em> I had a random number, what would I do with it?” <code>FromRandom</code> basically contains a function <code>r -&gt; a</code>…if I had a random number, how would I get my <code>a</code>? Note that this can really contain a function from <em>any</em> <code>r</code> you want, as long as it is a part of the <code>Random</code> typeclass. So we can have something that takes any random <code>Bool</code> to a <code>String</code>:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dt">FromRandom</span> (\r <span class="ot">-&gt;</span> show (<span class="ot">r ::</span> <span class="dt">Bool</span>))<span class="ot"> ::</span> <span class="dt">RandF</span> <span class="dt">String</span></code></pre></div>
<p>Which says, “if I had a random <code>Bool</code>, then I’d <code>show</code> it, to get a <code>String</code>”.</p>
<p>Or maybe something that takes any random <code>Double</code> to an <code>Int</code>, like:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dt">FromRandom</span> (\r <span class="ot">-&gt;</span> round (<span class="dv">100</span> <span class="fu">*</span> r <span class="fu">*</span><span class="ot"> r ::</span> <span class="dt">Double</span>))<span class="ot"> ::</span> <span class="dt">RandF</span> <span class="dt">Int</span></code></pre></div>
<p>“If I had a random <code>Double</code>, I’d square it and divide it by three, then round it, to get my <code>Int</code>”.</p>
<p>Or something as simple as just getting a random <code>Double</code>:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dt">FromRandom</span><span class="ot"> id ::</span> <span class="dt">RandF</span> <span class="dt">Double</span></code></pre></div>
<p>“If I had a random <code>Double</code>…well, that’s what I want in the end.”</p>
<p><code>FromRandomR</code> takes a range first before giving the function; <code>FromRandoms</code> asks, “if I had an infinite list of random items, what would I do?”</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="dt">FromRandomR</span> <span class="dv">0</span> <span class="dv">10</span> (\r <span class="ot">-&gt;</span> <span class="dv">1</span> <span class="fu">/</span> sqrt r)<span class="ot"> ::</span> <span class="dt">RandF</span> <span class="dt">Double</span>
<span class="dt">FromRandoms</span> (\rs <span class="ot">-&gt;</span> sum (take <span class="dv">10</span> rs))<span class="ot"> ::</span> <span class="dt">RandF</span> <span class="dt">Double</span></code></pre></div>
<p>We can “evaluate” the random value in a <code>RandF</code> by just generating a random value of the type desired and then applying the function to it. One typical way of doing this is to ask for a random generator/seed from the user:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- source: https://github.com/mstksg/inCode/tree/master/code-samples/free-random/Rand.hs#L31-35</span>
<span class="ot">runRandomF ::</span> <span class="dt">RandomGen</span> g <span class="ot">=&gt;</span> <span class="dt">RandF</span> a <span class="ot">-&gt;</span> g <span class="ot">-&gt;</span> a
runRandomF (<span class="dt">FromRandom</span> f)         <span class="fu">=</span> f <span class="fu">.</span> fst <span class="fu">.</span> random
runRandomF (<span class="dt">FromRandomR</span> r0 r1 f)  <span class="fu">=</span> f <span class="fu">.</span> fst <span class="fu">.</span> randomR (r0, r1)
runRandomF (<span class="dt">FromRandoms</span> f)        <span class="fu">=</span> f <span class="fu">.</span> randoms
runRandomF (<span class="dt">FromRandomRs</span> r0 r1 f) <span class="fu">=</span> f <span class="fu">.</span> randomRs (r0, r1)</code></pre></div>
<p>We can try some of these out:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">ghci<span class="fu">&gt;</span> <span class="kw">let</span> s <span class="fu">=</span> mkStdGen <span class="dv">192837465</span>
ghci<span class="fu">&gt;</span> runRandomF (<span class="dt">FromRandom</span> (\r <span class="ot">-&gt;</span> show (<span class="ot">r ::</span> <span class="dt">Bool</span>))) s
<span class="st">&quot;False&quot;</span>
ghci<span class="fu">&gt;</span> runRandomF (<span class="dt">FromRandom</span> (\r <span class="ot">-&gt;</span> round (<span class="dv">100</span> <span class="fu">*</span> r <span class="fu">*</span> r))) s
<span class="dv">32</span>
ghci<span class="fu">&gt;</span> runRandomF (<span class="dt">FromRandom</span><span class="ot"> id ::</span> <span class="dt">RandF</span> <span class="dt">Double</span>) s
<span class="fl">0.5631451666688826</span>
ghci<span class="fu">&gt;</span> runRandomF (<span class="dt">FromRandomR</span> <span class="dv">0</span> <span class="dv">10</span> (\r <span class="ot">-&gt;</span> <span class="dv">1</span> <span class="fu">/</span> sqrt r)) s
<span class="fl">0.4213954281350406</span>
ghci<span class="fu">&gt;</span> runRandomF (<span class="dt">FromRandoms</span> (sum <span class="fu">.</span> take <span class="dv">10</span>)<span class="ot"> ::</span> <span class="dt">RandF</span> <span class="dt">Double</span>) s
<span class="fl">9.434604856390711</span></code></pre></div>
<p>We might also realize that we can make a <code>Functor</code> instance on <code>RandF</code>, where <code>fmap</code> is like applying the fmapping function to the outbound value. For example, if we had <code>FromRandom (\r -&gt; r * 2)</code>, if we <code>fmap show</code>, we would want <code>FromRandom (\r -&gt; show (r * 2))</code>, so whenever we “ran” the <code>RandF</code>…if it was “meant” to make a <code>10</code> originally, it would now make a <code>&quot;10&quot;</code>.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- source: https://github.com/mstksg/inCode/tree/master/code-samples/free-random/Rand.hs#L24-29</span>
<span class="kw">instance</span> <span class="dt">Functor</span> <span class="dt">RandF</span> <span class="kw">where</span>
    fmap h rnd <span class="fu">=</span> <span class="kw">case</span> rnd <span class="kw">of</span>
        <span class="dt">FromRandom</span>         f <span class="ot">-&gt;</span> <span class="dt">FromRandom</span>         (h <span class="fu">.</span> f)
        <span class="dt">FromRandomR</span> r0 r1  f <span class="ot">-&gt;</span> <span class="dt">FromRandomR</span> r0 r1  (h <span class="fu">.</span> f)
        <span class="dt">FromRandoms</span>        f <span class="ot">-&gt;</span> <span class="dt">FromRandoms</span>        (h <span class="fu">.</span> f)
        <span class="dt">FromRandomRs</span> r0 r1 f <span class="ot">-&gt;</span> <span class="dt">FromRandomRs</span> r0 r1 (h <span class="fu">.</span> f)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">ghci<span class="fu">&gt;</span> <span class="kw">let</span> s <span class="fu">=</span> mkStdGen <span class="dv">192837465</span>
ghci<span class="fu">&gt;</span> <span class="kw">let</span> r <span class="fu">=</span> <span class="dt">FromRandom</span> (\r <span class="ot">-&gt;</span> round (<span class="dv">100</span> <span class="fu">*</span> r <span class="fu">*</span> r))
ghci<span class="fu">&gt;</span> runRandomF r s
<span class="dv">32</span>
ghci<span class="fu">&gt;</span> runRandomF (fmap show r) s
<span class="st">&quot;32&quot;</span>
ghci<span class="fu">&gt;</span> runRandomF (fmap negate r) s
<span class="fu">-</span><span class="dv">32</span></code></pre></div>
<p>Put in a rather abstract way, if you think of a <code>RandF Double</code> as something that “contains” a random <code>Double</code>, waiting to be computed…then <code>fmap show</code> applies <code>show</code> to the “contained” random <code>Double</code>.</p></div><footer><ul class="entry-series"></ul><ul class="tag-list"><li><a href="http://mstksg.github.com/inCode/entries/tagged/haskell" class="tag-a-tag">#haskell</a></li><li><a href="http://mstksg.github.com/inCode/entries/tagged/monads" class="tag-a-tag">#monads</a></li><li><a href="http://mstksg.github.com/inCode/entries/category/@haskell" class="tag-a-category">@HASKELL</a></li><li><a href="http://mstksg.github.com/inCode/entries/category/@projects" class="tag-a-category">@PROJECTS</a></li><li><a href="http://mstksg.github.com/inCode/entries/category/@ramblings" class="tag-a-category">@RAMBLINGS</a></li></ul><aside class="social-buttons"><div class="addthis_toolbox addthis_default_style addthis-buttons"><a class="addthis_button_facebook_like" fb:like:layout="button_count"></a><a class="addthis_button_tweet"></a><a class="addthis_button_google_plusone" g:plusone:size="medium"></a><a class="addthis_counter addthis_pill_style"></a></div><div class="custom-social-buttons"><div class="custom-social-button"><su:badge layout="1"></su:badge></div><div class="custom-social-button"><a href="http://www.reddit.com/submit" onclick="window.location = &#39;http://www.reddit.com/submit?url=&#39;+ encodeURIComponent(window.location); return false"><img src="http://www.reddit.com/static/spreddit7.gif" alt="submit to reddit"></a></div></div></aside><nav class="next-prev-links"><ul><li class="next-entry-link">(Next) <a href="http://mstksg.github.com/inCode/entry/fixed-length-vector-types-in-haskell-2015">Fixed-Length Vector Types in Haskell, 2015</a> &rarr;</li></ul></nav></footer></article><div class="post-entry"><div class="tile"><div id="disqus_thread"></div><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a><br></noscript><a href="http://disqus.com" class="dsq-brlink">Comments powered by <span class="logo-disqus">Disqus</span></a></div></div></div></div></div><div id="footer-container"><div id="footer-content"><div class="tile"><div class="footer-copyright">&copy; 2016 Justin Le</div><div class="footer-follow social-follows"><ul class="social-follows-list"><li><ul class="social-follows-list-social"><li><a class="social-follow-facebook" title="Friend me on Facebook!" href="https://facebook.com/mstksg">Facebook</a></li><li><a class="social-follow-twitter" title="Follow me on Twitter!" href="https://twitter.com/intent/user?user_id=mstk" onclick="window.open(
  &#39;http://twitter.com/intent/user?user_id=907281&#39;,
  &#39;facebook-share-dialog&#39;,
  &#39;width=550,height=520&#39;);
return false;
">Twitter</a></li><li><a class="social-follow-gplus" title="Add me on Google+!" href="https://plus.google.com/+JustinLe">Google+</a></li><li><a class="social-follow-linkedin" title="Connect with me on LinkedIn!" href="https://linkedin.com/in/mstksg">LinkedIn</a></li><li><a class="social-follow-github" title="Fork me on Github!" href="https://github.com/lejustin">Github</a></li></ul></li><li><ul class="social-follows-list-site"><li><a class="social-follow-rss" title="Subscribe to my RSS Feed!" href="http://feeds.feedburner.com/incodeblog">RSS</a></li><li><a class="social-follow-email" title="Subscribe to the mailing list!" href="https://feedburner.google.com/fb/a/mailverify?loc=en_US&amp;uri=incodeblog">Mailing list</a></li></ul></li></ul></div></div></div></div></body></html>